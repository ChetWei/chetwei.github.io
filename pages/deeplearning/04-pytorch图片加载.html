<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pytorch 加载图片 | 小魏同学的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/icon.png">
    <meta name="description" content="点滴学习记录">
    
    <link rel="preload" href="/assets/css/0.styles.fd72d8d4.css" as="style"><link rel="preload" href="/assets/js/app.5c1b57ed.js" as="script"><link rel="preload" href="/assets/js/2.219bfd91.js" as="script"><link rel="preload" href="/assets/js/12.52c259df.js" as="script"><link rel="prefetch" href="/assets/js/10.33d18704.js"><link rel="prefetch" href="/assets/js/11.98e3596c.js"><link rel="prefetch" href="/assets/js/13.0c68c86f.js"><link rel="prefetch" href="/assets/js/14.770f2800.js"><link rel="prefetch" href="/assets/js/15.56d2c625.js"><link rel="prefetch" href="/assets/js/16.ef638dbd.js"><link rel="prefetch" href="/assets/js/17.37c996f0.js"><link rel="prefetch" href="/assets/js/18.83288f53.js"><link rel="prefetch" href="/assets/js/19.5ad535fb.js"><link rel="prefetch" href="/assets/js/20.a3d384c2.js"><link rel="prefetch" href="/assets/js/21.274e9fa8.js"><link rel="prefetch" href="/assets/js/22.08bd1ce9.js"><link rel="prefetch" href="/assets/js/23.53acf99f.js"><link rel="prefetch" href="/assets/js/24.5c0072b9.js"><link rel="prefetch" href="/assets/js/3.bb6241e9.js"><link rel="prefetch" href="/assets/js/4.7adb1798.js"><link rel="prefetch" href="/assets/js/5.d3359473.js"><link rel="prefetch" href="/assets/js/6.5eff19f1.js"><link rel="prefetch" href="/assets/js/7.8dbf1c37.js"><link rel="prefetch" href="/assets/js/8.0e0f227d.js"><link rel="prefetch" href="/assets/js/9.82bb104a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fd72d8d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.png" alt="小魏同学的博客" class="logo"> <span class="site-name can-hide">小魏同学的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/jdk8.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/dubbo.html" class="nav-link">
  Java框架
</a></li></ul></div></div><div class="nav-item"><a href="/pages/deeplearning/01-CNN手写数字.html" class="nav-link">
  深度学习
</a></div><div class="nav-item"><a href="/pages/tools/docker操作.html" class="nav-link">
  工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/jdk8.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/dubbo.html" class="nav-link">
  Java框架
</a></li></ul></div></div><div class="nav-item"><a href="/pages/deeplearning/01-CNN手写数字.html" class="nav-link">
  深度学习
</a></div><div class="nav-item"><a href="/pages/tools/docker操作.html" class="nav-link">
  工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>深度学习</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/deeplearning/00-论文复现逻辑.html" class="sidebar-link">读那些论文</a></li><li><a href="/pages/deeplearning/01-CNN手写数字.html" class="sidebar-link">CNN手写数字识别</a></li><li><a href="/pages/deeplearning/02-matplotlib.html" class="sidebar-link">matplotlib学习</a></li><li><a href="/pages/deeplearning/03-numpy.html" class="sidebar-link">numpy</a></li><li><a href="/pages/deeplearning/04-pytorch图片加载.html" class="active sidebar-link">pytorch 加载图片</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/deeplearning/04-pytorch图片加载.html#pytorch-加载图片" class="sidebar-link">pytorch 加载图片</a></li><li class="sidebar-sub-header"><a href="/pages/deeplearning/04-pytorch图片加载.html#tensorboard使用" class="sidebar-link">Tensorboard使用</a></li><li class="sidebar-sub-header"><a href="/pages/deeplearning/04-pytorch图片加载.html#图像变换-transform的使用" class="sidebar-link">图像变换，transform的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/deeplearning/04-pytorch图片加载.html#_1-transform-resize-图像尺寸变换" class="sidebar-link">1. transform.Resize() 图像尺寸变换</a></li><li class="sidebar-sub-header"><a href="/pages/deeplearning/04-pytorch图片加载.html#_2-transforms-normalize-数据标准化" class="sidebar-link">2.transforms.normalize() 数据标准化</a></li></ul></li></ul></li><li><a href="/pages/deeplearning/kaggle猫狗分类.html" class="sidebar-link">kaggle 猫狗分类数据集测试</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="pytorch-加载图片"><a href="#pytorch-加载图片" class="header-anchor">#</a> pytorch 加载图片</h2> <p>使用pytorch制作图像数据集时，需要将存储在磁盘、硬盘的图像读取到内存中，涉及到图像I/O问题。</p> <p>在python中，图像处理主要采用的库：<strong>skimage, opencv-python, Pillow (PIL)</strong>。 这三个库均提供了图像读取的方法。</p> <table><thead><tr><th>库</th> <th>方法</th> <th>返回值</th> <th>图像像素格式</th> <th>像素值范围</th> <th>图像矩阵表示</th></tr></thead> <tbody><tr><td>skimage</td> <td>o.imread(path)</td> <td>numpy.ndarray</td> <td>RGB</td> <td>[0, 255]</td> <td>(H X W X C)</td></tr> <tr><td>cv2</td> <td>cv2.imread(path)</td> <td>numpy.ndarray</td> <td>BGR</td> <td>[0, 255]</td> <td>(H X W X C)</td></tr> <tr><td>Pillow(PIL)</td> <td>Image.open(path)</td> <td>PIL.Image.Image对象</td> <td>根据图像格式，一般为RGB</td> <td>[0, 255]</td> <td>—</td></tr></tbody></table> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> skimage<span class="token punctuation">.</span>io <span class="token keyword">as</span> io
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch

<span class="token comment"># dog.jpg    width = 1599, height=1066, channel=3</span>

<span class="token comment"># 使用skimage读取图像</span>
img_skimage <span class="token operator">=</span> io<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'dog.jpg'</span><span class="token punctuation">)</span>        <span class="token comment"># skimage.io imread()-----np.ndarray,  (H x W x C), [0, 255],RGB</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>img_skimage<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 使用opencv读取图像</span>
img_cv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'dog.jpg'</span><span class="token punctuation">)</span>            <span class="token comment"># cv2.imread()------np.array, (H x W xC), [0, 255], BGR</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>img_cv<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 使用PIL读取</span>
img_pil <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'dog.jpg'</span><span class="token punctuation">)</span>         <span class="token comment"># PIL.Image.Image对象</span>
img_pil_1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img_pil<span class="token punctuation">)</span>           <span class="token comment"># (H x W x C), [0, 255], RGB</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>img_pil_1<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> im <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>img_skimage<span class="token punctuation">,</span> img_cv<span class="token punctuation">,</span> img_pil_1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>pause<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="tensorboard使用"><a href="#tensorboard使用" class="header-anchor">#</a> Tensorboard使用</h2> <blockquote><p>在训练神经网络时，我们希望能更直观地了解训练情况，包括损失曲线、输入图片、输出图片、卷积核的参数分布等信息。这些信息能帮助我们更好地监督网络的训练过程，并为参数优化提供方向和依据。最简单的办法就是打印输出，但其只能打印数值信息，不够直观，同时无法查看分布、图片、声音等。接下来，将介绍两个深度学习中常用的可视化工具之一：Tensorboard。</p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>tensorboard <span class="token keyword">import</span> SummaryWriter


 tensorboard <span class="token operator">-</span><span class="token operator">-</span>logdir<span class="token operator">=</span>logs <span class="token operator">-</span><span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">6007</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="图像变换-transform的使用"><a href="#图像变换-transform的使用" class="header-anchor">#</a> 图像变换，transform的使用</h2> <h3 id="_1-transform-resize-图像尺寸变换"><a href="#_1-transform-resize-图像尺寸变换" class="header-anchor">#</a> 1. transform.Resize() 图像尺寸变换</h3> <p><strong>调整PILImage对象的尺寸</strong>，注意不能是用<code>io.imread</code>或者<code>cv2.imread</code>读取的图片，这两种方法得到的是<code>ndarray</code>。</p> <p>将图片短边缩放至x，长宽比保持不变：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而一般输入深度网络的特征图长宽是相等的，就不能采取等比例缩放的方式了，需要同时指定长宽：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span>h<span class="token punctuation">,</span> w<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>这样虽然会改变图片的长宽比，<strong>但是本身并没有发生裁切</strong>，仍可以通过resize方法返回原来的形状：</p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms

img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'1.jpg'</span><span class="token punctuation">)</span>
 w<span class="token punctuation">,</span> h <span class="token operator">=</span> img<span class="token punctuation">.</span>size
    
resize <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">244</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> resize<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'2.jpg'</span><span class="token punctuation">)</span>

resize2 <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span>h<span class="token punctuation">,</span> w<span class="token punctuation">]</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> resize2<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'3.jpg'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>原始图 500*399</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109211044197.png" alt="image-20210921104412025"></p> <p>转换后的图 224*224</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109211044228.png" alt="image-20210921104447165"></p> <blockquote><p>需要注意的一点是PILImage对象size属性返回的是w, h，而resize的参数顺序是h, w。</p></blockquote> <h3 id="_2-transforms-normalize-数据标准化"><a href="#_2-transforms-normalize-数据标准化" class="header-anchor">#</a> 2.transforms.normalize() 数据标准化</h3> <blockquote><p>功能：逐channel的对图像进行标准化（均值变为0，标准差变为1），可以加快模型的收敛
output = (input - mean) / std
mean:各通道的均值
std：各通道的标准差
inplace：是否原地操作</p> <p>思考：
（1）据我所知，归一化就是要把图片3个通道中的数据整理到[-1, 1]区间。
x = (x - mean(x))/std(x)
只要输入数据集x确定了，mean(x)和std(x)也就是确定的数值了，为什么Normalize()函数还需要输入mean和std的数值呢？？？？</p> <p>（2）RGB单个通道的值是[0, 255]，所以一个通道的均值应该在127附近才对。
如果Normalize()函数去计算 x = (x - mean)/std ，因为RGB是[0, 255]，算出来的x就不可能落在[-1, 1]区间了。</p> <p>（3）在我看的了论文代码里面是这样的：
torchvision.transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
为什么就确定了这一组数值，这一组数值是怎么来的？ 为什么这三个通道的均值都是小于1的值呢？</p> <p>理解：
（1）针对第一个问题，mean 和 std 肯定要在normalize（）之前自己先算好再传进去的，不然每次normalize（）就得把所有的图片都读取一遍算这两个
（2）针对第二个问题，有两种情况
（a )如果是imagenet数据集，那么ImageNet的数据在加载的时候就已经转换成了[0, 1].
（b) 应用了torchvision.transforms.ToTensor，其作用是将数据归一化到[0,1]（是将数据除以255），transforms.ToTensor（）会把HWC会变成C *H *W（拓展：格式为(h,w,c)，像素顺序为RGB）
（3）针对第三个问题：[0.485, 0.456, 0.406]这一组平均值是从imagenet训练集中抽样算出来的。
继续有疑问：
ToTensor 已经[0,1]为什么还要[0.485, 0.456, 0.406]？那么归一化后为什么还要接一个Normalize()呢?Normalize()是对数据按通道进行标准化，即减去均值，再除以方差</p></blockquote> <h4 id="训练好网络模型的保存和加载"><a href="#训练好网络模型的保存和加载" class="header-anchor">#</a> 训练好网络模型的保存和加载</h4> <h5 id="只保存和加载模型参数-推荐使用-但需要重新模型结构"><a href="#只保存和加载模型参数-推荐使用-但需要重新模型结构" class="header-anchor">#</a> 只保存和加载模型参数（推荐使用，但需要重新模型结构）</h5> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#保存模型</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>the_model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PATH<span class="token punctuation">)</span>

<span class="token comment">#提取模型</span>
<span class="token comment">#需要先重新模型结构</span>
the_model <span class="token operator">=</span> TheModelClass<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
<span class="token comment">#再加载参数</span>
the_model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>PATH<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="保存和加载整个模型"><a href="#保存和加载整个模型" class="header-anchor">#</a> 保存和加载整个模型</h5> <p>如下会保存整个网络，如果数据量比较大，会消耗大量时间。占用的内存也比较高，所以不推荐使用</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 保存</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>the_model<span class="token punctuation">,</span> PATH<span class="token punctuation">)</span>
<span class="token comment"># 提取</span>
the_model <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>PATH<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="损失函数的选择"><a href="#损失函数的选择" class="header-anchor">#</a> 损失函数的选择</h4> <h4 id="优化器的选择"><a href="#优化器的选择" class="header-anchor">#</a> 优化器的选择</h4> <h4 id="tqdm-进度条库"><a href="#tqdm-进度条库" class="header-anchor">#</a> tqdm 进度条库</h4></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/deeplearning/03-numpy.html" class="prev">
        numpy
      </a></span> <span class="next"><a href="/pages/deeplearning/kaggle猫狗分类.html">
        kaggle 猫狗分类数据集测试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c1b57ed.js" defer></script><script src="/assets/js/2.219bfd91.js" defer></script><script src="/assets/js/12.52c259df.js" defer></script>
  </body>
</html>
