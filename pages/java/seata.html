<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>seata 分布式事务 | 小魏同学的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/icon.png">
    <meta name="description" content="点滴学习记录">
    
    <link rel="preload" href="/assets/css/0.styles.fd72d8d4.css" as="style"><link rel="preload" href="/assets/js/app.5c1b57ed.js" as="script"><link rel="preload" href="/assets/js/2.219bfd91.js" as="script"><link rel="preload" href="/assets/js/18.83288f53.js" as="script"><link rel="prefetch" href="/assets/js/10.33d18704.js"><link rel="prefetch" href="/assets/js/11.98e3596c.js"><link rel="prefetch" href="/assets/js/12.52c259df.js"><link rel="prefetch" href="/assets/js/13.0c68c86f.js"><link rel="prefetch" href="/assets/js/14.770f2800.js"><link rel="prefetch" href="/assets/js/15.56d2c625.js"><link rel="prefetch" href="/assets/js/16.ef638dbd.js"><link rel="prefetch" href="/assets/js/17.37c996f0.js"><link rel="prefetch" href="/assets/js/19.5ad535fb.js"><link rel="prefetch" href="/assets/js/20.a3d384c2.js"><link rel="prefetch" href="/assets/js/21.274e9fa8.js"><link rel="prefetch" href="/assets/js/22.08bd1ce9.js"><link rel="prefetch" href="/assets/js/23.53acf99f.js"><link rel="prefetch" href="/assets/js/24.5c0072b9.js"><link rel="prefetch" href="/assets/js/3.bb6241e9.js"><link rel="prefetch" href="/assets/js/4.7adb1798.js"><link rel="prefetch" href="/assets/js/5.d3359473.js"><link rel="prefetch" href="/assets/js/6.5eff19f1.js"><link rel="prefetch" href="/assets/js/7.8dbf1c37.js"><link rel="prefetch" href="/assets/js/8.0e0f227d.js"><link rel="prefetch" href="/assets/js/9.82bb104a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fd72d8d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.png" alt="小魏同学的博客" class="logo"> <span class="site-name can-hide">小魏同学的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/jdk8.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/dubbo.html" class="nav-link">
  Java框架
</a></li></ul></div></div><div class="nav-item"><a href="/pages/deeplearning/01-CNN手写数字.html" class="nav-link">
  深度学习
</a></div><div class="nav-item"><a href="/pages/tools/docker操作.html" class="nav-link">
  工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/jdk8.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/dubbo.html" class="nav-link">
  Java框架
</a></li></ul></div></div><div class="nav-item"><a href="/pages/deeplearning/01-CNN手写数字.html" class="nav-link">
  深度学习
</a></div><div class="nav-item"><a href="/pages/tools/docker操作.html" class="nav-link">
  工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/java/01-jdk8.html" class="sidebar-link">jdk8新特性</a></li><li><a href="/pages/java/02-spring.html" class="sidebar-link">Spring5</a></li><li><a href="/pages/java/dubbo.html" class="sidebar-link">springcloud alibaba nacos dubbo 整合</a></li><li><a href="/pages/java/rocketmq.html" class="sidebar-link">/pages/java/rocketmq.html</a></li><li><a href="/pages/java/seata.html" aria-current="page" class="active sidebar-link">seata 分布式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/seata.html#一、docker安装seata" class="sidebar-link">一、docker安装seata</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_1、使用自定义配置文件" class="sidebar-link">1、使用自定义配置文件</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_2、这里我们注册中心使用nacos-配置中心也使用nacos" class="sidebar-link">2、这里我们注册中心使用nacos，配置中心也使用nacos</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_3、下载配置-nacos-config-txt-并上传到nacos配置中心" class="sidebar-link">3、下载配置 nacos-config.txt，并上传到nacos配置中心</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_4、执行nacos-config-sh脚本上传配置到nacos" class="sidebar-link">4、执行nacos-config.sh脚本上传配置到nacos</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_4、db模式建表" class="sidebar-link">4、db模式建表</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_5、启动容器" class="sidebar-link">5、启动容器</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_6、环境变量" class="sidebar-link">6、环境变量</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_7、此时nacos对应的命名空间中就有了seata服务和相关的配置" class="sidebar-link">7、此时nacos对应的命名空间中就有了seata服务和相关的配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#二、在应用中使用seata" class="sidebar-link">二、在应用中使用seata</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_1、引入依赖" class="sidebar-link">1、引入依赖</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_2、开始测试" class="sidebar-link">2、开始测试</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#_3、发生问题的情况" class="sidebar-link">3、发生问题的情况：</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#三、探究seata原理" class="sidebar-link">三、探究seata原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/seata.html#架构图" class="sidebar-link">架构图</a></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#seata-at-模式" class="sidebar-link">Seata AT 模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/java/seata.html#整体机制" class="sidebar-link">整体机制</a></li></ul></li><li><a href="/pages/java/springboot.html" class="sidebar-link">springboot</a></li><li><a href="/pages/java/springboot_thread.html" class="sidebar-link">在springboot项目中使用异步来发送短信</a></li><li><a href="/pages/java/springcloud.html" class="sidebar-link">开始搭建 springcloud 脚手架</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度学习</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="seata-分布式事务"><a href="#seata-分布式事务" class="header-anchor">#</a> seata 分布式事务</h1> <p>https://seata.io/zh-cn/docs/user/quickstart.html</p> <p>https://developer.aliyun.com/article/768872?spm=a2c6h.14164896.0.0.1d3c55faNaLdgz</p> <h2 id="一、docker安装seata"><a href="#一、docker安装seata" class="header-anchor">#</a> 一、docker安装seata</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>docker pull seataio/seata-server:1.4.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1、使用自定义配置文件"><a href="#_1、使用自定义配置文件" class="header-anchor">#</a> 1、使用自定义配置文件</h3> <p>下载seata的安装包，解压后复制三个文件，到映射目录</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161905592.png" alt="image-20210612230549072"></p> <h3 id="_2、这里我们注册中心使用nacos-配置中心也使用nacos"><a href="#_2、这里我们注册中心使用nacos-配置中心也使用nacos" class="header-anchor">#</a> 2、这里我们注册中心使用nacos，配置中心也使用nacos</h3> <p>所以file.conf我们用不到</p> <p>配置文件</p> <p>registry.conf</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>registry <span class="token punctuation">{</span>
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  # 配置seata的注册中心
  type = <span class="token string">&quot;nacos&quot;</span>

  nacos <span class="token punctuation">{</span>
    application = <span class="token string">&quot;seata-server&quot;</span>
	#nacos是docker启动的，要指定nacos在docker的内网ip
    serverAddr = <span class="token string">&quot;172.17.0.3:8848&quot;</span>
    group = <span class="token string">&quot;SEATA_GROUP&quot;</span>
    namespace = <span class="token string">&quot;cb3c788b-94a8-4ae0-b010-c24aacb51ede&quot;</span>
    cluster = <span class="token string">&quot;default&quot;</span>
    username = <span class="token string">&quot;nacos&quot;</span>
    password = <span class="token string">&quot;nacos&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# 指定seata的参数配置方式
config <span class="token punctuation">{</span>
  # file、nacos 、apollo、zk、consul、etcd3
  type = <span class="token string">&quot;nacos&quot;</span>

 nacos <span class="token punctuation">{</span>
    #nacos是docker启动的，要指定nacos在docker的内网ip
    serverAddr = <span class="token string">&quot;172.17.0.3:8848&quot;</span>
    namespace = <span class="token string">&quot;cb3c788b-94a8-4ae0-b010-c24aacb51ede&quot;</span>
    group = <span class="token string">&quot;SEATA_GROUP&quot;</span>
    username = <span class="token string">&quot;nacos&quot;</span>
    password = <span class="token string">&quot;nacos&quot;</span>
    dataId = <span class="token string">&quot;seataServer.properties&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>既然我们不用file.conf作为配置文件，那么我们要初始化seata的配置参数到nacos配置中心</p> <h3 id="_3、下载配置-nacos-config-txt-并上传到nacos配置中心"><a href="#_3、下载配置-nacos-config-txt-并上传到nacos配置中心" class="header-anchor">#</a> 3、下载配置 nacos-config.txt，并上传到nacos配置中心</h3> <p>文件地址：https://github.com/seata/seata/blob/1.3.0/script/config-center/config.txt</p> <p>官网seata-server-0.9.0的conf目录下有该文件，官网seata-server-0.9.0的conf目录下有该文件，后面的版本无该文件需要手动下载执行。</p> <p>修改为自己的服务组名，各个微服务之间使用相同的服务组名，务必保持一致！</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">service.vgroupMapping.my_test_tx_group</span><span class="token punctuation">=</span><span class="token attr-value">default</span>
<span class="token attr-name">service.vgroupMapping.my_test_tx_group1</span><span class="token punctuation">=</span><span class="token attr-value">default</span>
<span class="token attr-name">service.vgroupMapping.my_test_tx_group2</span><span class="token punctuation">=</span><span class="token attr-value">default</span>
<span class="token attr-name">service.vgroupMapping.my_test_tx_group3</span><span class="token punctuation">=</span><span class="token attr-value">default</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>修改后的精简内容 config.txt</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">service.vgroupMapping.my_test_tx_group</span><span class="token punctuation">=</span><span class="token attr-value">default</span>
<span class="token attr-name">service.default.grouplist</span><span class="token punctuation">=</span><span class="token attr-value">127.0.0.1:8091</span>
<span class="token attr-name">store.mode</span><span class="token punctuation">=</span><span class="token attr-value">db</span>
<span class="token attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token attr-value">druid</span>
<span class="token attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token attr-value">mysql</span>
<span class="token attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># 这里的mysql存储方式，mysql的ip要是docker的内网ip</span>
<span class="token attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://172.17.0.4:3306/seata?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useSSL=false</span>
<span class="token attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">store.db.minConn</span><span class="token punctuation">=</span><span class="token attr-value">5</span>
<span class="token attr-name">store.db.maxConn</span><span class="token punctuation">=</span><span class="token attr-value">30</span>
<span class="token attr-name">store.db.globalTable</span><span class="token punctuation">=</span><span class="token attr-value">global_table</span>
<span class="token attr-name">store.db.branchTable</span><span class="token punctuation">=</span><span class="token attr-value">branch_table</span>
<span class="token attr-name">store.db.queryLimit</span><span class="token punctuation">=</span><span class="token attr-value">100</span>
<span class="token attr-name">store.db.lockTable</span><span class="token punctuation">=</span><span class="token attr-value">lock_table</span>
<span class="token attr-name">store.db.maxWait</span><span class="token punctuation">=</span><span class="token attr-value">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_4、执行nacos-config-sh脚本上传配置到nacos"><a href="#_4、执行nacos-config-sh脚本上传配置到nacos" class="header-anchor">#</a> 4、执行nacos-config.sh脚本上传配置到nacos</h3> <p>脚本地址：<a href="https://github.com/seata/seata/blob/1.3.0/script/config-center/nacos/nacos-config.sh?spm=a2c6h.12873639.0.0.cb551821U4GnFi&amp;file=nacos-config.sh" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/blob/1.3.0/script/config-center/nacos/nacos-config.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>官网seata-server-0.9.0的conf目录下有该文件，后面的版本无该文件需要手动下载执行。</p> <p>如果本地是windows，使用git工具git bash执行nacos-config.sh脚本：</p> <p>上传配置文件到nacos 这里的config.txt在nacos-config.sh的上级目录中</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sh</span> nacos-config.sh -h localhost -p <span class="token number">8848</span> -g SEATA_GROUP -t cb3c788b-94a8-4ae0-b010-c24aacb51ede -u nacos -w nacos
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>命令解析：-h -p 指定nacos的端口地址；-g 指定配置的分组，注意，是配置的分组；-t 指定命名空间id； -u -w指定nacos的用户名和密码，同样，这里开启了nacos注册和配置认证的才需要指定。</p></blockquote> <h3 id="_4、db模式建表"><a href="#_4、db模式建表" class="header-anchor">#</a> 4、db模式建表</h3> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>-- 新建数据库seata, 创建如下三个表，用于seata服务
-- the table to store GlobalSession data
DROP TABLE IF EXISTS `global_table`;
CREATE TABLE `global_table` (
  `xid` VARCHAR(128)  NOT NULL,
  `transaction_id` BIGINT,
  `status` TINYINT NOT NULL,
  `application_id` VARCHAR(32),
  `transaction_service_group` VARCHAR(32),
  `transaction_name` VARCHAR(128),
  `timeout` INT,
  `begin_time` BIGINT,
  `application_data` VARCHAR(2000),
  `gmt_create` DATETIME,
  `gmt_modified` DATETIME,
  PRIMARY KEY (`xid`),
  KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),
  KEY `idx_transaction_id` (`transaction_id`)
);

-- the table to store BranchSession data
DROP TABLE IF EXISTS `branch_table`;
CREATE TABLE `branch_table` (
  `branch_id` BIGINT NOT NULL,
  `xid` VARCHAR(128) NOT NULL,
  `transaction_id` BIGINT ,
  `resource_group_id` VARCHAR(32),
  `resource_id` VARCHAR(256) ,
  `lock_key` VARCHAR(128) ,
  `branch_type` VARCHAR(8) ,
  `status` TINYINT,
  `client_id` VARCHAR(64),
  `application_data` VARCHAR(2000),
  `gmt_create` DATETIME,
  `gmt_modified` DATETIME,
  PRIMARY KEY (`branch_id`),
  KEY `idx_xid` (`xid`)
);

-- the table to store lock data
DROP TABLE IF EXISTS `lock_table`;
CREATE TABLE `lock_table` (
  `row_key` VARCHAR(128) NOT NULL,
  `xid` VARCHAR(96),
  `transaction_id` LONG ,
  `branch_id` LONG,
  `resource_id` VARCHAR(256) ,
  `table_name` VARCHAR(32) ,
  `pk` VARCHAR(36) ,
  `gmt_create` DATETIME ,
  `gmt_modified` DATETIME,
  PRIMARY KEY(`row_key`)
);


-- AT模式下每个业务数据库需要创建undo_log表，用于seata记录分支的回滚信息
-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log 
CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  `ext` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p><strong>seata数据库</strong></p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161905310.png" alt="image-20210613141802532"></p> <p><strong>业务数据库</strong></p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161905014.png" alt="image-20210613141831699"></p> <h3 id="_5、启动容器"><a href="#_5、启动容器" class="header-anchor">#</a> 5、启动容器</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>docker run --name seata-server -p <span class="token number">8091</span>:8091 -e <span class="token assign-left variable">SEATA_IP</span><span class="token operator">=</span><span class="token number">172.23</span>.16.1   -e <span class="token assign-left variable">SEATA_CONFIG_NAME</span><span class="token operator">=</span>file:/root/seata-config/registry  -v /E/docker-v/seata/config:/root/seata-config  -d seataio/seata-server:1.4.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>指定ip为外网ip，而不是容器ip</p> <ul><li>指定 registry.conf</li></ul> <p>自定义配置文件需要通过挂载文件的方式实现，将宿主机上的 <code>registry.conf</code> 和 <code>file.conf</code> 挂载到容器中相应的目录，其中 <code>-e</code> 用于配置环境变量， <code>-v</code> 用于挂载宿主机的目录。</p> <ul><li>如果是使用本地文件配置的方式要 指定 file.conf</li></ul> <p>如果需要同时指定 <code>file.conf</code> 配置文件，则需要在 <code>registry.conf</code> 文件中将 <code>config</code> 配置改为以下内容，<code>name</code> 的值为容器中对应的路径</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>#registry.conf
config <span class="token punctuation">{</span>
  type = <span class="token string">&quot;file&quot;</span>

  file <span class="token punctuation">{</span>
    name = <span class="token string">&quot;file:/root/seata-config/file.conf&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_6、环境变量"><a href="#_6、环境变量" class="header-anchor">#</a> 6、环境变量</h3> <p>seata-server 支持以下环境变量：</p> <ul><li><strong>SEATA_IP</strong></li></ul> <blockquote><p>可选, 指定seata-server启动的IP, 该IP用于向注册中心注册时使用, 如eureka等</p></blockquote> <ul><li><strong>SEATA_PORT</strong></li></ul> <blockquote><p>可选, 指定seata-server启动的端口, 默认为 <code>8091</code></p></blockquote> <ul><li><strong>STORE_MODE</strong></li></ul> <blockquote><p>可选, 指定seata-server的事务日志存储方式, 支持<code>db</code> ,<code>file</code>,redis(Seata-Server 1.3及以上版本支持), 默认是 <code>file</code></p></blockquote> <ul><li><strong>SERVER_NODE</strong></li></ul> <blockquote><p>可选, 用于指定seata-server节点ID, 如 <code>1</code>,<code>2</code>,<code>3</code>..., 默认为 <code>根据ip生成</code></p></blockquote> <ul><li><strong>SEATA_ENV</strong></li></ul> <blockquote><p>可选, 指定 seata-server 运行环境, 如 <code>dev</code>, <code>test</code> 等, 服务启动时会使用 <code>registry-dev.conf</code> 这样的配置</p></blockquote> <ul><li><strong>SEATA_CONFIG_NAME</strong></li></ul> <blockquote><p>可选, 指定配置文件位置, 如 <code>file:/root/registry</code>, 将会加载 <code>/root/registry.conf</code> 作为配置文件，如果需要同时指定 <code>file.conf</code>文件，需要将<code>registry.conf</code>的<code>config.file.name</code>的值改为类似<code>file:/root/file.conf</code>：</p></blockquote> <h3 id="_7、此时nacos对应的命名空间中就有了seata服务和相关的配置"><a href="#_7、此时nacos对应的命名空间中就有了seata服务和相关的配置" class="header-anchor">#</a> 7、此时nacos对应的命名空间中就有了seata服务和相关的配置</h3> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161905506.png" alt="image-20210613141642409"></p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161905825.png" alt="image-20210613141713919"></p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906386.png" alt="image-20210613141730232"></p> <h2 id="二、在应用中使用seata"><a href="#二、在应用中使用seata" class="header-anchor">#</a> 二、在应用中使用seata</h2> <h3 id="_1、引入依赖"><a href="#_1、引入依赖" class="header-anchor">#</a> 1、引入依赖</h3> <div class="language-html line-numbers-mode"><pre class="language-html"><code>        <span class="token comment">&lt;!--分布式事务seata--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>2、在各个微服务中配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment">#seata 分布式事务配置</span>
<span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">application-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
  <span class="token comment">#这个配置就是启动自动开启数据源代理</span>
  <span class="token key atrule">enable-auto-data-source-proxy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment">#这个是事务分组，项目的微服务都要配置一样的事务分组，并</span>
  <span class="token comment">#和service.vgroupMapping.my_test_tx_group=default一致。</span>
  <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> my_test_tx_group
  <span class="token comment">################注册中心###################</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cb3c788b<span class="token punctuation">-</span>94a8<span class="token punctuation">-</span>4ae0<span class="token punctuation">-</span>b010<span class="token punctuation">-</span>c24aacb51ede
      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default
      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
  <span class="token comment">################配置中心###################</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cb3c788b<span class="token punctuation">-</span>94a8<span class="token punctuation">-</span>4ae0<span class="token punctuation">-</span>b010<span class="token punctuation">-</span>c24aacb51ede
      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>在启动类中配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//因为seata采用了DataSource代理方式操作数据，所以在springboot项目中先要排除datasource初始化，</span>
<span class="token comment">// 这样yml文件中的seata.enable-auto-data-source-proxy: true 自动代理才会生效。</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2、开始测试"><a href="#_2、开始测试" class="header-anchor">#</a> 2、开始测试</h3> <p>场景：<strong>订单服务</strong>、<strong>库存服务</strong>、<strong>账户服务</strong></p> <p>订单服务收到请求创建订单：</p> <p>​	1、订单服务调用库存服务扣减库存</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//扣减库存</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductProduct</span><span class="token punctuation">(</span><span class="token keyword">int</span> productId<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">ProductEntity</span> productDB <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ProductEntity</span><span class="token operator">::</span><span class="token function">getProductId</span><span class="token punctuation">,</span> productId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>productDB<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> count<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    productDB<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>productDB<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    baseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>productDB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>​	2、订单服务调用账户服务扣减余额</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//扣减余额</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductMoney</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token class-name">AccountEntity</span> userDB <span class="token operator">=</span> accountMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccountEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">AccountEntity</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>userDB<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//余额不足</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;余额不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//余额充足</span>
    userDB<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>userDB<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accountMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>userDB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>​	3、订单服务生成订单信息</p> <p>在订单服务中的业务方法中使用 <code>@GlobalTransactional(rollbackFor = Exception.class)</code> 注解，即可使用seata全局事务</p> <p>其他被调用的服务不需要使用这个注解</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//订单服务生成订单信息</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IOrderService</span> <span class="token punctuation">{</span>

   <span class="token comment">//账户服务调用使用的是dubbo</span>
    <span class="token annotation punctuation">@DubboReference</span>
    <span class="token keyword">private</span> <span class="token class-name">IAccountDubboApi</span> accountDubboApi<span class="token punctuation">;</span>

    <span class="token comment">//库存服务调用使用的是feign</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IProductFeignClient</span> productFeignClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 创建订单
     * @param userId 用户id
     * @param productId 产品id
     * @param count    产品数量
     * @param money
     */</span>
    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">//使用seata全局事务</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> productId<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> money<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.扣减库存</span>
        productFeignClient<span class="token punctuation">.</span><span class="token function">deductProduct</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.扣减余额</span>
        accountDubboApi<span class="token punctuation">.</span><span class="token function">deductMoney</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.创建订单</span>
        <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderEntity<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderEntity<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderEntity<span class="token punctuation">.</span><span class="token function">setProductId</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderEntity<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;异常了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="_3、发生问题的情况"><a href="#_3、发生问题的情况" class="header-anchor">#</a> 3、发生问题的情况：</h3> <blockquote><p>库存服务调用成功并且数据库库存已经减少，此时undo_log有一条库存更新记录</p> <p>当调用余额服务扣减余额时，发现余额不足抛出异常</p> <p>库存服务进行回滚，并删除了undo_log中的内容</p></blockquote> <blockquote><p>库存服务成功，数据库更新成功，undo_log有一条库存更新记录</p> <p>账户服务成功，数据库更新成功，undo_log有一条账户更新记录</p> <p>订单服务本身出现异常，对库存服务和账户服务进行回滚，删除undo_log中的两条记录</p></blockquote> <h2 id="三、探究seata原理"><a href="#三、探究seata原理" class="header-anchor">#</a> 三、探究seata原理</h2> <p>http://seata.io/zh-cn/docs/user/quickstart.html</p> <p>用户购买商品的业务逻辑。整个业务逻辑由3个微服务提供支持：</p> <ul><li>仓储服务：对给定的商品扣除仓储数量。</li> <li>订单服务：根据采购需求创建订单。</li> <li>帐户服务：从用户帐户中扣除余额。</li></ul> <h3 id="架构图"><a href="#架构图" class="header-anchor">#</a> 架构图</h3> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906233.png" alt="Architecture"></p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906710.png" alt="img"></p> <h3 id="seata-at-模式"><a href="#seata-at-模式" class="header-anchor">#</a> Seata AT 模式</h3> <h2 id="整体机制"><a href="#整体机制" class="header-anchor">#</a> 整体机制</h2> <p>两阶段提交协议的演变：</p> <ul><li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li> <li>二阶段：
<ul><li>提交异步化，非常快速地完成。</li> <li>回滚通过一阶段的回滚日志进行反向补偿。</li></ul></li></ul> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906857.jpg" alt="img"></p> <p>既然 <code>Seata</code> 是两段提交，那我们看看它在每个阶段都做了点啥？下边我们还以下单扣库存、扣余额举例。</p> <p>先介绍 <code>Seata</code> 分布式事务的几种角色：</p> <ul><li><code>Transaction Coordinator(TC)</code>: 全局事务协调者，用来协调全局事务和各个分支事务（不同服务）的状态， 驱动全局事务和各个分支事务的回滚或提交。</li> <li><code>Transaction Manager™</code>: 事务管理者，业务层中用来开启/提交/回滚一个整体事务（在调用服务的方法中用注解开启事务）。</li> <li><code>Resource Manager(RM)</code>: 资源管理者，一般指业务数据库代表了一个分支事务（<code>Branch Transaction</code>），管理分支事务与 <code>TC</code> 进行协调注册分支事务并且汇报分支事务的状态，驱动分支事务的提交或回滚。</li></ul> <blockquote><p>Seata 实现分布式事务，设计了一个关键角色 <code>UNDO_LOG</code> （回滚日志记录表），我们在每个应用分布式事务的业务库中创建这张表，这个表的核心作用就是，将业务数据在更新前后的数据镜像组织成回滚日志，备份在 <code>UNDO_LOG</code> 表中，以便业务异常能随时回滚。</p></blockquote> <h4 id="第一个阶段"><a href="#第一个阶段" class="header-anchor">#</a> 第一个阶段</h4> <p>比如：下边我们更新 <code>user</code> 表的 <code>name</code> 字段。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">'小富最帅'</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'程序员内点事'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>首先 Seata 的 <code>JDBC</code> 数据源代理通过对业务 SQL 解析，提取 SQL 的元数据，也就是得到 SQL 的类型（<code>UPDATE</code>），表（<code>user</code>），条件（<code>where name = '程序员内点事'</code>）等相关的信息。</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906409.jpg" alt="img"></p> <p>先查询数据前镜像，根据解析得到的条件信息，生成查询语句，定位一条数据。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span>  name <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'程序员内点事'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906522.jpg" alt="img"></p> <p>紧接着执行业务 SQL，根据前镜像数据主键查询出后镜像数据</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> name <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906664.jpg" alt="img"></p> <p>把业务数据在更新前后的数据镜像组织成回滚日志，将业务数据的更新和回滚日志在同一个本地事务中提交，分别插入到业务表和 <code>UNDO_LOG</code> 表中。</p> <p>回滚记录数据格式如下：包括 <code>afterImage</code> 前镜像、<code>beforeImage</code> 后镜像、 <code>branchId</code> 分支事务ID、<code>xid</code> 全局事务ID</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;branchId&quot;</span><span class="token operator">:</span><span class="token number">641789253</span><span class="token punctuation">,</span>
    <span class="token property">&quot;xid&quot;</span><span class="token operator">:</span><span class="token string">&quot;xid:xxx&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;undoItems&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;afterImage&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">&quot;rows&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
                            <span class="token punctuation">{</span>
                                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">1</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span><span class="token string">&quot;product&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;beforeImage&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">&quot;rows&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
                            <span class="token punctuation">{</span>
                                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">1</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span><span class="token string">&quot;product&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sqlType&quot;</span><span class="token operator">:</span><span class="token string">&quot;UPDATE&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>这样就可以保证，任何提交的业务数据的更新一定有相应的回滚日志。</p> <blockquote><p>在本地事务提交前，各分支事务需向 <code>全局事务协调者</code> TC 注册分支 ( <code>Branch Id</code>) ，为要修改的记录申请 <strong>全局锁</strong> ，要为这条数据加锁，利用 <code>SELECT FOR UPDATE</code> 语句。而如果一直拿不到锁那就需要回滚本地事务。TM 开启事务后会生成全局唯一的 <code>XID</code>，会在各个调用的服务间进行传递。</p></blockquote> <p>有了这样的机制，本地事务分支（<code>Branch Transaction</code>）便可以在全局事务的第一阶段提交，并马上释放本地事务锁定的资源。相比于传统的 <code>XA</code> 事务在第二阶段释放资源，<code>Seata</code> 降低了锁范围提高效率，即使第二阶段发生异常需要回滚，也可以快速 从<code>UNDO_LOG</code> 表中找到对应回滚数据并反解析成 SQL 来达到回滚补偿。</p> <p>最后本地事务提交，业务数据的更新和前面生成的 UNDO LOG 数据一并提交，并将本地事务提交的结果上报给全局事务协调者 TC。</p> <h4 id="第二阶段"><a href="#第二阶段" class="header-anchor">#</a> 第二阶段</h4> <p>第二阶段是根据各分支的决议做提交或回滚：</p> <ul><li>如果决议是全局提交，此时各分支事务已提交并成功，这时 <code>全局事务协调者（TC）</code> 会向分支发送第二阶段的请求。TM收到 TC 的分支提交请求，该请求会被放入一个异步任务队列中，并马上返回提交成功结果给 TC。异步队列中会异步和批量地根据 <code>Branch ID</code> 查找并删除相应 <code>UNDO LOG</code> 回滚记录。</li></ul> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906335.jpg" alt="img"></p> <ul><li><p>如果决议是全局回滚，过程比全局提交麻烦一点，<code>RM</code> 服务方收到 <code>TC</code> 全局协调者发来的回滚请求，通过 <code>XID</code> 和 <code>Branch ID</code> 找到相应的回滚日志记录，通过回滚记录生成反向的更新 SQL 并执行，以完成分支的回滚。</p> <blockquote><p>注意：这里删除回滚日志记录操作，一定是在本地业务事务执行之后</p></blockquote></li></ul> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906850.jpg" alt="img"></p> <p>以一个示例来说明：</p> <blockquote><p>两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 的初始值 1000。</p></blockquote> <p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 <strong>全局锁</strong> ，本地提交释放本地锁。</p> <p>tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 <strong>全局锁</strong> ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 <strong>全局锁</strong> 。</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161906030.png" alt="Write-Isolation: Commit"></p> <p>tx1 二阶段全局提交，释放 <strong>全局锁</strong> 。tx2 拿到 <strong>全局锁</strong> 提交本地事务。</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161907989.png" alt="Write-Isolation: Rollback"></p> <p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。</p> <p>此时，如果 tx2 仍在等待该数据的 <strong>全局锁</strong>，同时持有本地锁，则 tx1 的分支回滚会失败。分支的回滚会一直重试，直到 tx2 的 <strong>全局锁</strong> 等锁超时，放弃 <strong>全局锁</strong> 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。</p> <p>因为整个过程 <strong>全局锁</strong> 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 <strong>脏写</strong> 的问题。</p> <h4 id="读隔离"><a href="#读隔离" class="header-anchor">#</a> 读隔离</h4> <p>在数据库本地事务隔离级别 <strong>读已提交（Read Committed）</strong> 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 <strong>读未提交（Read Uncommitted）</strong> 。</p> <p>如果应用在特定场景下，必需要求全局的 <strong>读已提交</strong> ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161907386.png" alt="Read Isolation: SELECT FOR UPDATE"></p> <p>SELECT FOR UPDATE 语句的执行会申请 <strong>全局锁</strong> ，如果 <strong>全局锁</strong> 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 <strong>全局锁</strong> 拿到，即读取的相关数据是 <strong>已提交</strong> 的，才返回。</p> <blockquote><p>出于总体性能上的考虑，Seata 目前的方案并没有对所有 SELECT 语句都进行代理，仅针对 FOR UPDATE 的 SELECT 语句。</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/java/rocketmq.html" class="prev">
        /pages/java/rocketmq.html
      </a></span> <span class="next"><a href="/pages/java/springboot.html">
        springboot
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c1b57ed.js" defer></script><script src="/assets/js/2.219bfd91.js" defer></script><script src="/assets/js/18.83288f53.js" defer></script>
  </body>
</html>
