<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小魏同学的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/icon.png">
    <meta name="description" content="点滴学习记录">
    
    <link rel="preload" href="/assets/css/0.styles.fd72d8d4.css" as="style"><link rel="preload" href="/assets/js/app.5c1b57ed.js" as="script"><link rel="preload" href="/assets/js/2.219bfd91.js" as="script"><link rel="preload" href="/assets/js/17.37c996f0.js" as="script"><link rel="prefetch" href="/assets/js/10.33d18704.js"><link rel="prefetch" href="/assets/js/11.98e3596c.js"><link rel="prefetch" href="/assets/js/12.52c259df.js"><link rel="prefetch" href="/assets/js/13.0c68c86f.js"><link rel="prefetch" href="/assets/js/14.770f2800.js"><link rel="prefetch" href="/assets/js/15.56d2c625.js"><link rel="prefetch" href="/assets/js/16.ef638dbd.js"><link rel="prefetch" href="/assets/js/18.83288f53.js"><link rel="prefetch" href="/assets/js/19.5ad535fb.js"><link rel="prefetch" href="/assets/js/20.a3d384c2.js"><link rel="prefetch" href="/assets/js/21.274e9fa8.js"><link rel="prefetch" href="/assets/js/22.08bd1ce9.js"><link rel="prefetch" href="/assets/js/23.53acf99f.js"><link rel="prefetch" href="/assets/js/24.5c0072b9.js"><link rel="prefetch" href="/assets/js/3.bb6241e9.js"><link rel="prefetch" href="/assets/js/4.7adb1798.js"><link rel="prefetch" href="/assets/js/5.d3359473.js"><link rel="prefetch" href="/assets/js/6.5eff19f1.js"><link rel="prefetch" href="/assets/js/7.8dbf1c37.js"><link rel="prefetch" href="/assets/js/8.0e0f227d.js"><link rel="prefetch" href="/assets/js/9.82bb104a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fd72d8d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.png" alt="小魏同学的博客" class="logo"> <span class="site-name can-hide">小魏同学的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/jdk8.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/dubbo.html" class="nav-link">
  Java框架
</a></li></ul></div></div><div class="nav-item"><a href="/pages/deeplearning/01-CNN手写数字.html" class="nav-link">
  深度学习
</a></div><div class="nav-item"><a href="/pages/tools/docker操作.html" class="nav-link">
  工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/jdk8.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/dubbo.html" class="nav-link">
  Java框架
</a></li></ul></div></div><div class="nav-item"><a href="/pages/deeplearning/01-CNN手写数字.html" class="nav-link">
  深度学习
</a></div><div class="nav-item"><a href="/pages/tools/docker操作.html" class="nav-link">
  工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/java/01-jdk8.html" class="sidebar-link">jdk8新特性</a></li><li><a href="/pages/java/02-spring.html" class="sidebar-link">Spring5</a></li><li><a href="/pages/java/dubbo.html" class="sidebar-link">springcloud alibaba nacos dubbo 整合</a></li><li><a href="/pages/java/rocketmq.html" aria-current="page" class="active sidebar-link">/pages/java/rocketmq.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/rocketmq.html#rockermq-docker-安装" class="sidebar-link">rockermq docker 安装</a></li><li class="sidebar-sub-header"><a href="/pages/java/rocketmq.html#应用场景" class="sidebar-link">应用场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/rocketmq.html#rocketmq基本概念" class="sidebar-link">RocketMq基本概念</a></li><li class="sidebar-sub-header"><a href="/pages/java/rocketmq.html#rocketmq-环境搭建" class="sidebar-link">RocketMQ 环境搭建</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/java/rocketmq.html#rocketmq-高可用集群环境" class="sidebar-link">RocketMQ 高可用集群环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/java/rocketmq.html#基本样例" class="sidebar-link">基本样例</a></li></ul></li></ul></li><li><a href="/pages/java/seata.html" class="sidebar-link">seata 分布式事务</a></li><li><a href="/pages/java/springboot.html" class="sidebar-link">springboot</a></li><li><a href="/pages/java/springboot_thread.html" class="sidebar-link">在springboot项目中使用异步来发送短信</a></li><li><a href="/pages/java/springcloud.html" class="sidebar-link">开始搭建 springcloud 脚手架</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度学习</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><ol><li>应用模块遇到要发送事务消息的场景时，先发送<code>半消息</code>给 MQ Server。</li> <li>MQ Server返回<code>半消息</code>收到通知,MQ发送方得知半消息发送成功，应用模块执行数据库事务（本地事务）。</li> <li>MQ发送方 根据数据库事务执行的结果，再返回Commit或Rollback给 MQ Server。</li> <li>如果是Commit，MQ Server 把消息下发给Consumer端，如果是Rollback，直接删掉向下传递的<code>半消息</code>。</li> <li>第3步的执行结果如果没响应，或是超时的，<code>MQ Server</code> 启动定时任务回查事务状态（最多重试15次，超过了默认丢弃此消息），处理结果同第4步。</li> <li>MQ消费的成功机制由MQ自己保证。</li></ol> <p>https://blog.csdn.net/ming19951224/article/details/109063041</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161908927.png" alt="image-20210614143838730"></p> <h2 id="rockermq-docker-安装"><a href="#rockermq-docker-安装" class="header-anchor">#</a> rockermq docker 安装</h2> <p>1、设置映射文件目录和配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>----rocketmq
---------docker-compose.yml
---------conf
-------------broker.conf

---------namesrv
-------------store
-------------logs

---------broker
-------------store
-------------logs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>broker.conf</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code>
<span class="token comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="token comment"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="token comment"># this work for additional information regarding copyright ownership.</span>
<span class="token comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="token comment"># (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="token comment"># the License.  You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="token comment">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment">#  See the License for the specific language governing permissions and</span>
<span class="token comment">#  limitations under the License.</span>
 
 
<span class="token comment"># 所属集群名字</span>
<span class="token attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token attr-value">DefaultCluster</span>
 
<span class="token comment"># broker 名字，注意此处不同的配置文件填写的不一样，如果在 broker-a.properties 使用: broker-a,</span>
<span class="token comment"># 在 broker-b.properties 使用: broker-b</span>
<span class="token attr-name">brokerName</span><span class="token punctuation">=</span><span class="token attr-value">broker-a</span>
 
<span class="token comment"># 0 表示 Master，&gt; 0 表示 Slave</span>
<span class="token attr-name">brokerId</span><span class="token punctuation">=</span><span class="token attr-value">0</span>
 
<span class="token comment"># nameServer地址，分号分割</span>
<span class="token comment"># namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span>
 
<span class="token comment"># 启动IP,如果 docker 报 com.alibaba.rocketmq.remoting.exception.RemotingConnectException: connect to &lt;192.168.0.120:10909&gt; failed</span>
<span class="token comment"># 解决方式1 加上一句 producer.setVipChannelEnabled(false);，解决方式2 brokerIP1 设置宿主机IP，不要使用docker 内部IP</span>
<span class="token attr-name">brokerIP1</span><span class="token punctuation">=</span><span class="token attr-value">192.168.1.100</span>
 
<span class="token comment"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
<span class="token attr-name">defaultTopicQueueNums</span><span class="token punctuation">=</span><span class="token attr-value">4</span>
 
<span class="token comment">#使用 RocketMQ 进行发消息时，必须要指定 topic，对于 topic 的设置有一个开关autoCreateTopicEnable，一般在开发测试环境中会使用默认设置autoCreateTopicEnable = true，但是这样就会导致 topic 的设置不容易规范管理，没有统一的审核等等，所以在正式环境中会在 Broker 启动时设置参数autoCreateTopicEnable = false。这样当需要增加 topic 时就需要在 web 管理界面上添加即可。</span>
<span class="token comment"># 是否允许 Broker 自动创建 Topic，建议线下开启，线上关闭 ！！！这里仔细看是 false，false，false</span>
<span class="token attr-name">autoCreateTopicEnable</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
 
<span class="token comment"># 是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
<span class="token attr-name">autoCreateSubscriptionGroup</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
 
<span class="token comment"># Broker 对外服务的监听端口</span>
<span class="token attr-name">listenPort</span><span class="token punctuation">=</span><span class="token attr-value">10911</span>
 
<span class="token comment"># 删除文件时间点，默认凌晨4点</span>
<span class="token attr-name">deleteWhen</span><span class="token punctuation">=</span><span class="token attr-value">04</span>
 
<span class="token comment"># 文件保留时间，默认48小时</span>
<span class="token attr-name">fileReservedTime</span><span class="token punctuation">=</span><span class="token attr-value">120</span>
 
<span class="token comment"># commitLog 每个文件的大小默认1G</span>
<span class="token attr-name">mapedFileSizeCommitLog</span><span class="token punctuation">=</span><span class="token attr-value">1073741824</span>
 
<span class="token comment"># ConsumeQueue 每个文件默认存 30W 条，根据业务情况调整</span>
<span class="token attr-name">mapedFileSizeConsumeQueue</span><span class="token punctuation">=</span><span class="token attr-value">300000</span>
 
<span class="token comment"># destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment"># redeleteHangedFileInterval=120000</span>
<span class="token comment"># 检测物理文件磁盘空间</span>
<span class="token attr-name">diskMaxUsedSpaceRatio</span><span class="token punctuation">=</span><span class="token attr-value">88</span>
<span class="token comment"># 存储路径</span>
<span class="token comment"># storePathRootDir=/home/ztztdata/rocketmq-all-4.1.0-incubating/store</span>
<span class="token comment"># commitLog 存储路径</span>
<span class="token comment"># storePathCommitLog=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/commitlog</span>
<span class="token comment"># 消费队列存储</span>
<span class="token comment"># storePathConsumeQueue=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/consumequeue</span>
<span class="token comment"># 消息索引存储路径</span>
<span class="token comment"># storePathIndex=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/index</span>
<span class="token comment"># checkpoint 文件存储路径</span>
<span class="token comment"># storeCheckpoint=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/checkpoint</span>
<span class="token comment"># abort 文件存储路径</span>
<span class="token comment"># abortFile=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/abort</span>
<span class="token comment"># 限制的消息大小</span>
<span class="token attr-name">maxMessageSize</span><span class="token punctuation">=</span><span class="token attr-value">65536</span>
 
<span class="token comment"># flushCommitLogLeastPages=4</span>
<span class="token comment"># flushConsumeQueueLeastPages=2</span>
<span class="token comment"># flushCommitLogThoroughInterval=10000</span>
<span class="token comment"># flushConsumeQueueThoroughInterval=60000</span>
 
<span class="token comment"># Broker 的角色</span>
<span class="token comment"># - ASYNC_MASTER 异步复制Master</span>
<span class="token comment"># - SYNC_MASTER 同步双写Master</span>
<span class="token comment"># - SLAVE</span>
<span class="token attr-name">brokerRole</span><span class="token punctuation">=</span><span class="token attr-value">ASYNC_MASTER</span>
 
<span class="token comment"># 刷盘方式</span>
<span class="token comment"># - ASYNC_FLUSH 异步刷盘</span>
<span class="token comment"># - SYNC_FLUSH 同步刷盘</span>
<span class="token attr-name">flushDiskType</span><span class="token punctuation">=</span><span class="token attr-value">ASYNC_FLUSH</span>
 
<span class="token comment"># 发消息线程池数量</span>
<span class="token comment"># sendMessageThreadPoolNums=128</span>
<span class="token comment"># 拉消息线程池数量</span>
<span class="token comment"># pullMessageThreadPoolNums=128</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><p>docker-compose.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.5&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">rmqnamesrv</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> foxiswho/rocketmq<span class="token punctuation">:</span>4.7.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rmqnamesrv
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9876<span class="token punctuation">:</span><span class="token number">9876</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token comment">#换成自己的本地映射目录</span>
      <span class="token punctuation">-</span> ./rmqs/logs<span class="token punctuation">:</span>/opt/logs
      <span class="token punctuation">-</span> ./rmqs/store<span class="token punctuation">:</span>/opt/store
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">JAVA_OPT_EXT</span><span class="token punctuation">:</span> <span class="token string">&quot;-Duser.home=/opt -Xms512M -Xmx512M -Xmn128m&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mqnamesrv&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">rmq</span><span class="token punctuation">:</span>
        <span class="token key atrule">aliases</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> rmqnamesrv
  <span class="token key atrule">rmqbroker</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> foxiswho/rocketmq<span class="token punctuation">:</span>4.7.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rmqbroker
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 10909<span class="token punctuation">:</span><span class="token number">10909</span>
      <span class="token punctuation">-</span> 10911<span class="token punctuation">:</span><span class="token number">10911</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
     <span class="token comment">#换成自己的本地映射目录</span>
      <span class="token punctuation">-</span> ./rmq/logs<span class="token punctuation">:</span>/opt/logs
      <span class="token punctuation">-</span> ./rmq/store<span class="token punctuation">:</span>/opt/store
      <span class="token punctuation">-</span> ./rmq/brokerconf/broker.conf<span class="token punctuation">:</span>/etc/rocketmq/broker.conf
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">JAVA_OPT_EXT</span><span class="token punctuation">:</span> <span class="token string">&quot;-Duser.home=/opt -Xms512M -Xmx512M -Xmn128m&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">[</span>
        <span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;mqbroker&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;/etc/rocketmq/broker.conf&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-n&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;rmqnamesrv:9876&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;autoCreateTopicEnable=true&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> rmqnamesrv
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">rmq</span><span class="token punctuation">:</span>
        <span class="token key atrule">aliases</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> rmqbroker

  <span class="token key atrule">rmqconsole</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> styletang/rocketmq<span class="token punctuation">-</span>console<span class="token punctuation">-</span>ng
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rmqconsole
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8088<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">JAVA_OPTS</span><span class="token punctuation">:</span> <span class="token string">&quot;-Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> rmqnamesrv
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">rmq</span><span class="token punctuation">:</span>
        <span class="token key atrule">aliases</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> rmqconsole

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">rmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>启动，在docker-compose.yml 目录下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker-compose up -d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问console页面端口 http://192.168.1.100:8088/</p> <h2 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h2> <ul><li><p>应用解耦</p></li> <li><p>流量削峰</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161909959.png" alt="image-20210613191230550"></p></li> <li><p>数据分发</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161909947.png" alt="111"></p></li></ul> <p>优缺点</p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161909408.png" alt="image-20210613191811752"></p> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161909001.png" alt="image-20210613192140027"></p> <p>消息队列的组成</p> <ul><li>Broker
消息服务器，作为server提供消息核心服务</li> <li>Producer
消息生产者，业务的发起方，生产消息传输给broker</li> <li>Consumer
消息消费者，业务处理方，负责从broker获取消息并进行业务逻辑处理</li> <li>Topic
主题，发布订阅模式下的消息统一汇集地，不同生产者向topic发送消息，由MQ服务器分发到不同的订阅者，实现消息</li> <li>Queue
队列，点对点模式下，特定生产者向特定queue发送消息，消费者订阅特定的queue完成指定消息的接收</li> <li>Message
消息体，根据不同通信协议定义的固定格式编码数据包，来封装业务数据，实现消息的传输。</li></ul> <h3 id="rocketmq基本概念"><a href="#rocketmq基本概念" class="header-anchor">#</a> RocketMq基本概念</h3> <ul><li><strong>名称服务器</strong>
名称服务器（NameServer）用来保存 Broker 相关元信息并给 Producer 和 Consumer 查找 Broker 信息。NameServer 被设计成几乎无状态的，可以横向扩展，节点之间相互之间无通信，通过部署多台机器来标记自己是一个伪集群。每个 Broker 在启动的时候会到 NameServer 注册，Producer 在发送消息前会根据 Topic 到 NameServer 获取到 Broker 的路由信息，Consumer 也会定时获取 Topic 的路由信息。所以从功能上看应该是和 ZooKeeper 差不多，据说 RocketMQ 的早期版本确实是使用的 ZooKeeper ，后来改为了自己实现的 NameServer</li> <li>消息
消息（Message）就是要传输的信息。一条消息必须有一个主题（Topic），主题可以看做是你的信件要邮寄的地址。一条消息也可以拥有一个可选的标签（Tag）和额处的键值对，它们可以用于设置一个业务 key 并在 Broker 上查找此消息以便在开发期间查找问题。</li> <li>主题
主题（Topic）可以看做消息的规类，它是消息的第一级类型。比如一个电商系统可以分为：交易消息、物流消息等，一条消息必须有一个 Topic 。Topic 与生产者和消费者的关系非常松散，一个 Topic 可以有0个、1个、多个生产者向其发送消息，一个生产者也可以同时向不同的 Topic 发送消息。一个 Topic 也可以被 0个、1个、多个消费者订阅</li> <li><strong>消息服务器</strong>
消息服务器（Broker）是消息存储中心，主要作用是接收来自 Producer 的消息并存储， Consumer 从这里取得消息。它还存储与消息相关的元数据，包括用户组、消费进度偏移量、队列信息等。从部署结构图中可以看出 Broker 有 Master 和 Slave 两种类型，Master 既可以写又可以读，Slave 不可以写只可以读。从物理结构上看 Broker 的集群部署方式有四种：单 Master 、多 Master 、多 Master 多 Slave（同步刷盘）、多 Master多 Slave（异步刷盘）。</li> <li>生产者组
生产者组（Producer Group）是一类 Producer 的集合，这类 Producer 通常发送一类消息并且发送逻辑一致，所以将这些 Producer 分组在一起。从部署结构上看生产者通过 Producer Group 的名字来标记自己是一个集群</li> <li>消息队列
消息队列（Message Queue），主题被划分为一个或多个子主题，即消息队列。一个 Topic 下可以设置多个消息队列，发送消息时执行该消息的 Topic ，RocketMQ 会轮询该 Topic 下的所有队列将消息发出去。下图 Broker 内部消息情况：</li></ul> <p><img src="https://gitee.com/ChetWei/img/raw/master/img/202109161909491.png" alt="image-20210613210759643"></p> <h3 id="rocketmq-环境搭建"><a href="#rocketmq-环境搭建" class="header-anchor">#</a> RocketMQ 环境搭建</h3> <p>docker 安装</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>docker pull rocketmqinc/rocketmq

<span class="token comment">#启动namesrv</span>

docker run -d -p <span class="token number">9876</span>:9876 -v /E/docker-v/rocketmq/data/namesrv/logs:/root/logs -v /E/docker-v/rocketmq/data/namesrv/store:/root/store --name rmqnamesrv -e <span class="token string">&quot;MAX_POSSIBLE_HEAP=100000000&quot;</span> rocketmqinc/rocketmq <span class="token function">sh</span> mqnamesrv

<span class="token comment">#启动broker</span>
docker run -d -p <span class="token number">10911</span>:10911 -p <span class="token number">10909</span>:10909 -v  /E/docker-v/rocketmq/data/broker/logs:/root/logs -v  /E/docker-v/rocketmq/data/broker/store:/root/store  -v /E/docker-v/rocketmq/conf/broker.conf:/opt/rocketmq/conf/broker.conf --name rmqbroker -e <span class="token string">&quot;NAMESRV_ADDR=namesrv:9876&quot;</span> -e <span class="token string">&quot;MAX_POSSIBLE_HEAP=200000000&quot;</span> rocketmqinc/rocketmq <span class="token function">sh</span> mqbroker -c /opt/rocketmq/conf/broker.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="rocketmq-高可用集群环境"><a href="#rocketmq-高可用集群环境" class="header-anchor">#</a> RocketMQ 高可用集群环境</h2> <h3 id="基本样例"><a href="#基本样例" class="header-anchor">#</a> 基本样例</h3> <p>https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md</p> <p>使用消息生产者分别通过三种方式发送消息，同步发送，异步发送，单向发送</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/java/dubbo.html" class="prev">
        springcloud alibaba nacos dubbo 整合
      </a></span> <span class="next"><a href="/pages/java/seata.html">
        seata 分布式事务
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c1b57ed.js" defer></script><script src="/assets/js/2.219bfd91.js" defer></script><script src="/assets/js/17.37c996f0.js" defer></script>
  </body>
</html>
