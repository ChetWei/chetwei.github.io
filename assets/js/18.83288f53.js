(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{383:function(s,t,a){"use strict";a.r(t);var n=a(45),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"seata-分布式事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seata-分布式事务"}},[s._v("#")]),s._v(" seata 分布式事务")]),s._v(" "),a("p",[s._v("https://seata.io/zh-cn/docs/user/quickstart.html")]),s._v(" "),a("p",[s._v("https://developer.aliyun.com/article/768872?spm=a2c6h.14164896.0.0.1d3c55faNaLdgz")]),s._v(" "),a("h2",{attrs:{id:"一、docker安装seata"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、docker安装seata"}},[s._v("#")]),s._v(" 一、docker安装seata")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("docker pull seataio/seata-server:1.4.2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1、使用自定义配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、使用自定义配置文件"}},[s._v("#")]),s._v(" 1、使用自定义配置文件")]),s._v(" "),a("p",[s._v("下载seata的安装包，解压后复制三个文件，到映射目录")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161905592.png",alt:"image-20210612230549072"}})]),s._v(" "),a("h3",{attrs:{id:"_2、这里我们注册中心使用nacos-配置中心也使用nacos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、这里我们注册中心使用nacos-配置中心也使用nacos"}},[s._v("#")]),s._v(" 2、这里我们注册中心使用nacos，配置中心也使用nacos")]),s._v(" "),a("p",[s._v("所以file.conf我们用不到")]),s._v(" "),a("p",[s._v("配置文件")]),s._v(" "),a("p",[s._v("registry.conf")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("registry "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa\n  # 配置seata的注册中心\n  type = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nacos"')]),s._v("\n\n  nacos "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    application = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"seata-server"')]),s._v("\n\t#nacos是docker启动的，要指定nacos在docker的内网ip\n    serverAddr = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.17.0.3:8848"')]),s._v("\n    group = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SEATA_GROUP"')]),s._v("\n    namespace = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cb3c788b-94a8-4ae0-b010-c24aacb51ede"')]),s._v("\n    cluster = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v("\n    username = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nacos"')]),s._v("\n    password = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nacos"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n# 指定seata的参数配置方式\nconfig "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  # file、nacos 、apollo、zk、consul、etcd3\n  type = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nacos"')]),s._v("\n\n nacos "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    #nacos是docker启动的，要指定nacos在docker的内网ip\n    serverAddr = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.17.0.3:8848"')]),s._v("\n    namespace = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cb3c788b-94a8-4ae0-b010-c24aacb51ede"')]),s._v("\n    group = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SEATA_GROUP"')]),s._v("\n    username = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nacos"')]),s._v("\n    password = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nacos"')]),s._v("\n    dataId = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"seataServer.properties"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("既然我们不用file.conf作为配置文件，那么我们要初始化seata的配置参数到nacos配置中心")]),s._v(" "),a("h3",{attrs:{id:"_3、下载配置-nacos-config-txt-并上传到nacos配置中心"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、下载配置-nacos-config-txt-并上传到nacos配置中心"}},[s._v("#")]),s._v(" 3、下载配置 nacos-config.txt，并上传到nacos配置中心")]),s._v(" "),a("p",[s._v("文件地址：https://github.com/seata/seata/blob/1.3.0/script/config-center/config.txt")]),s._v(" "),a("p",[s._v("官网seata-server-0.9.0的conf目录下有该文件，官网seata-server-0.9.0的conf目录下有该文件，后面的版本无该文件需要手动下载执行。")]),s._v(" "),a("p",[s._v("修改为自己的服务组名，各个微服务之间使用相同的服务组名，务必保持一致！")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("service.vgroupMapping.my_test_tx_group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("default")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("service.vgroupMapping.my_test_tx_group1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("default")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("service.vgroupMapping.my_test_tx_group2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("default")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("service.vgroupMapping.my_test_tx_group3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("default")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("修改后的精简内容 config.txt")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("service.vgroupMapping.my_test_tx_group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("default")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("service.default.grouplist")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("127.0.0.1:8091")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("db")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.datasource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("druid")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.dbType")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("mysql")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.driverClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("com.mysql.cj.jdbc.Driver")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里的mysql存储方式，mysql的ip要是docker的内网ip")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("jdbc:mysql://172.17.0.4:3306/seata?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true&useSSL=false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("root")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("root")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.minConn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("5")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.maxConn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("30")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.globalTable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("global_table")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.branchTable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("branch_table")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.queryLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("100")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.lockTable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("lock_table")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("store.db.maxWait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("5000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h3",{attrs:{id:"_4、执行nacos-config-sh脚本上传配置到nacos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、执行nacos-config-sh脚本上传配置到nacos"}},[s._v("#")]),s._v(" 4、执行nacos-config.sh脚本上传配置到nacos")]),s._v(" "),a("p",[s._v("脚本地址："),a("a",{attrs:{href:"https://github.com/seata/seata/blob/1.3.0/script/config-center/nacos/nacos-config.sh?spm=a2c6h.12873639.0.0.cb551821U4GnFi&file=nacos-config.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/seata/seata/blob/1.3.0/script/config-center/nacos/nacos-config.sh"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("官网seata-server-0.9.0的conf目录下有该文件，后面的版本无该文件需要手动下载执行。")]),s._v(" "),a("p",[s._v("如果本地是windows，使用git工具git bash执行nacos-config.sh脚本：")]),s._v(" "),a("p",[s._v("上传配置文件到nacos 这里的config.txt在nacos-config.sh的上级目录中")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" nacos-config.sh -h localhost -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8848")]),s._v(" -g SEATA_GROUP -t cb3c788b-94a8-4ae0-b010-c24aacb51ede -u nacos -w nacos\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v("命令解析：-h -p 指定nacos的端口地址；-g 指定配置的分组，注意，是配置的分组；-t 指定命名空间id； -u -w指定nacos的用户名和密码，同样，这里开启了nacos注册和配置认证的才需要指定。")])]),s._v(" "),a("h3",{attrs:{id:"_4、db模式建表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、db模式建表"}},[s._v("#")]),s._v(" 4、db模式建表")]),s._v(" "),a("div",{staticClass:"language-mysql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-- 新建数据库seata, 创建如下三个表，用于seata服务\n-- the table to store GlobalSession data\nDROP TABLE IF EXISTS `global_table`;\nCREATE TABLE `global_table` (\n  `xid` VARCHAR(128)  NOT NULL,\n  `transaction_id` BIGINT,\n  `status` TINYINT NOT NULL,\n  `application_id` VARCHAR(32),\n  `transaction_service_group` VARCHAR(32),\n  `transaction_name` VARCHAR(128),\n  `timeout` INT,\n  `begin_time` BIGINT,\n  `application_data` VARCHAR(2000),\n  `gmt_create` DATETIME,\n  `gmt_modified` DATETIME,\n  PRIMARY KEY (`xid`),\n  KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),\n  KEY `idx_transaction_id` (`transaction_id`)\n);\n\n-- the table to store BranchSession data\nDROP TABLE IF EXISTS `branch_table`;\nCREATE TABLE `branch_table` (\n  `branch_id` BIGINT NOT NULL,\n  `xid` VARCHAR(128) NOT NULL,\n  `transaction_id` BIGINT ,\n  `resource_group_id` VARCHAR(32),\n  `resource_id` VARCHAR(256) ,\n  `lock_key` VARCHAR(128) ,\n  `branch_type` VARCHAR(8) ,\n  `status` TINYINT,\n  `client_id` VARCHAR(64),\n  `application_data` VARCHAR(2000),\n  `gmt_create` DATETIME,\n  `gmt_modified` DATETIME,\n  PRIMARY KEY (`branch_id`),\n  KEY `idx_xid` (`xid`)\n);\n\n-- the table to store lock data\nDROP TABLE IF EXISTS `lock_table`;\nCREATE TABLE `lock_table` (\n  `row_key` VARCHAR(128) NOT NULL,\n  `xid` VARCHAR(96),\n  `transaction_id` LONG ,\n  `branch_id` LONG,\n  `resource_id` VARCHAR(256) ,\n  `table_name` VARCHAR(32) ,\n  `pk` VARCHAR(36) ,\n  `gmt_create` DATETIME ,\n  `gmt_modified` DATETIME,\n  PRIMARY KEY(`row_key`)\n);\n\n\n-- AT模式下每个业务数据库需要创建undo_log表，用于seata记录分支的回滚信息\n-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log \nCREATE TABLE `undo_log` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `branch_id` bigint(20) NOT NULL,\n  `xid` varchar(100) NOT NULL,\n  `context` varchar(128) NOT NULL,\n  `rollback_info` longblob NOT NULL,\n  `log_status` int(11) NOT NULL,\n  `log_created` datetime NOT NULL,\n  `log_modified` datetime NOT NULL,\n  `ext` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br")])]),a("p",[a("strong",[s._v("seata数据库")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161905310.png",alt:"image-20210613141802532"}})]),s._v(" "),a("p",[a("strong",[s._v("业务数据库")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161905014.png",alt:"image-20210613141831699"}})]),s._v(" "),a("h3",{attrs:{id:"_5、启动容器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5、启动容器"}},[s._v("#")]),s._v(" 5、启动容器")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("docker run --name seata-server -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8091")]),s._v(":8091 -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SEATA_IP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.23")]),s._v(".16.1   -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SEATA_CONFIG_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("file:/root/seata-config/registry  -v /E/docker-v/seata/config:/root/seata-config  -d seataio/seata-server:1.4.2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("指定ip为外网ip，而不是容器ip")]),s._v(" "),a("ul",[a("li",[s._v("指定 registry.conf")])]),s._v(" "),a("p",[s._v("自定义配置文件需要通过挂载文件的方式实现，将宿主机上的 "),a("code",[s._v("registry.conf")]),s._v(" 和 "),a("code",[s._v("file.conf")]),s._v(" 挂载到容器中相应的目录，其中 "),a("code",[s._v("-e")]),s._v(" 用于配置环境变量， "),a("code",[s._v("-v")]),s._v(" 用于挂载宿主机的目录。")]),s._v(" "),a("ul",[a("li",[s._v("如果是使用本地文件配置的方式要 指定 file.conf")])]),s._v(" "),a("p",[s._v("如果需要同时指定 "),a("code",[s._v("file.conf")]),s._v(" 配置文件，则需要在 "),a("code",[s._v("registry.conf")]),s._v(" 文件中将 "),a("code",[s._v("config")]),s._v(" 配置改为以下内容，"),a("code",[s._v("name")]),s._v(" 的值为容器中对应的路径")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("#registry.conf\nconfig "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  type = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file"')]),s._v("\n\n  file "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name = "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file:/root/seata-config/file.conf"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"_6、环境变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6、环境变量"}},[s._v("#")]),s._v(" 6、环境变量")]),s._v(" "),a("p",[s._v("seata-server 支持以下环境变量：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("SEATA_IP")])])]),s._v(" "),a("blockquote",[a("p",[s._v("可选, 指定seata-server启动的IP, 该IP用于向注册中心注册时使用, 如eureka等")])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("SEATA_PORT")])])]),s._v(" "),a("blockquote",[a("p",[s._v("可选, 指定seata-server启动的端口, 默认为 "),a("code",[s._v("8091")])])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("STORE_MODE")])])]),s._v(" "),a("blockquote",[a("p",[s._v("可选, 指定seata-server的事务日志存储方式, 支持"),a("code",[s._v("db")]),s._v(" ,"),a("code",[s._v("file")]),s._v(",redis(Seata-Server 1.3及以上版本支持), 默认是 "),a("code",[s._v("file")])])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("SERVER_NODE")])])]),s._v(" "),a("blockquote",[a("p",[s._v("可选, 用于指定seata-server节点ID, 如 "),a("code",[s._v("1")]),s._v(","),a("code",[s._v("2")]),s._v(","),a("code",[s._v("3")]),s._v("..., 默认为 "),a("code",[s._v("根据ip生成")])])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("SEATA_ENV")])])]),s._v(" "),a("blockquote",[a("p",[s._v("可选, 指定 seata-server 运行环境, 如 "),a("code",[s._v("dev")]),s._v(", "),a("code",[s._v("test")]),s._v(" 等, 服务启动时会使用 "),a("code",[s._v("registry-dev.conf")]),s._v(" 这样的配置")])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("SEATA_CONFIG_NAME")])])]),s._v(" "),a("blockquote",[a("p",[s._v("可选, 指定配置文件位置, 如 "),a("code",[s._v("file:/root/registry")]),s._v(", 将会加载 "),a("code",[s._v("/root/registry.conf")]),s._v(" 作为配置文件，如果需要同时指定 "),a("code",[s._v("file.conf")]),s._v("文件，需要将"),a("code",[s._v("registry.conf")]),s._v("的"),a("code",[s._v("config.file.name")]),s._v("的值改为类似"),a("code",[s._v("file:/root/file.conf")]),s._v("：")])]),s._v(" "),a("h3",{attrs:{id:"_7、此时nacos对应的命名空间中就有了seata服务和相关的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7、此时nacos对应的命名空间中就有了seata服务和相关的配置"}},[s._v("#")]),s._v(" 7、此时nacos对应的命名空间中就有了seata服务和相关的配置")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161905506.png",alt:"image-20210613141642409"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161905825.png",alt:"image-20210613141713919"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906386.png",alt:"image-20210613141730232"}})]),s._v(" "),a("h2",{attrs:{id:"二、在应用中使用seata"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、在应用中使用seata"}},[s._v("#")]),s._v(" 二、在应用中使用seata")]),s._v(" "),a("h3",{attrs:{id:"_1、引入依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、引入依赖"}},[s._v("#")]),s._v(" 1、引入依赖")]),s._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!--分布式事务seata--\x3e")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("io.seata"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("seata-spring-boot-starter"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1.4.2"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("com.alibaba.cloud"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("spring-cloud-starter-alibaba-seata"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("exclusions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("exclusion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("io.seata"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("seata-spring-boot-starter"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("exclusion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("exclusions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("2、在各个微服务中配置")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#seata 分布式事务配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("seata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("application-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("spring.application.name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这个配置就是启动自动开启数据源代理")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enable-auto-data-source-proxy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这个是事务分组，项目的微服务都要配置一样的事务分组，并")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#和service.vgroupMapping.my_test_tx_group=default一致。")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tx-service-group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my_test_tx_group\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("################注册中心###################")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("registry")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nacos\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("application")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8848")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" SEATA_GROUP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cb3c788b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("94a8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("4ae0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("b010"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c24aacb51ede\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nacos\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nacos\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("################配置中心###################")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nacos\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8848")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" SEATA_GROUP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cb3c788b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("94a8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("4ae0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("b010"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c24aacb51ede\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nacos\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nacos\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("在启动类中配置")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//因为seata采用了DataSource代理方式操作数据，所以在springboot项目中先要排除datasource初始化，")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这样yml文件中的seata.enable-auto-data-source-proxy: true 自动代理才会生效。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SpringBootApplication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("exclude "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DataSourceAutoConfiguration")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_2、开始测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、开始测试"}},[s._v("#")]),s._v(" 2、开始测试")]),s._v(" "),a("p",[s._v("场景："),a("strong",[s._v("订单服务")]),s._v("、"),a("strong",[s._v("库存服务")]),s._v("、"),a("strong",[s._v("账户服务")])]),s._v(" "),a("p",[s._v("订单服务收到请求创建订单：")]),s._v(" "),a("p",[s._v("​\t1、订单服务调用库存服务扣减库存")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//扣减库存")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Transactional")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("propagation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Propagation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("REQUIRED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("rollbackFor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("deductProduct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" productId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ProductEntity")]),s._v(" productDB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" baseMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("selectOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueryWrapper")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ProductEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("lambda")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("eq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ProductEntity")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getProductId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" productId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("productDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RuntimeException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    productDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("productDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    baseMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("updateById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("productDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("​\t2、订单服务调用账户服务扣减余额")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//扣减余额")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Transactional")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("propagation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Propagation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("REQUIRED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("rollbackFor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("deductMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BigDecimal")]),s._v(" money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AccountEntity")]),s._v(" userDB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" accountMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("selectOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueryWrapper")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AccountEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("lambda")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("eq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AccountEntity")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getUserId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("compareTo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//余额不足")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"余额不足"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//余额充足")]),s._v("\n    userDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("subtract")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    accountMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("updateById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userDB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("​\t3、订单服务生成订单信息")]),s._v(" "),a("p",[s._v("在订单服务中的业务方法中使用 "),a("code",[s._v("@GlobalTransactional(rollbackFor = Exception.class)")]),s._v(" 注解，即可使用seata全局事务")]),s._v(" "),a("p",[s._v("其他被调用的服务不需要使用这个注解")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//订单服务生成订单信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderServiceImpl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServiceImpl")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderMapper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOrderService")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//账户服务调用使用的是dubbo")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@DubboReference")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IAccountDubboApi")]),s._v(" accountDubboApi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//库存服务调用使用的是feign")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Autowired")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IProductFeignClient")]),s._v(" productFeignClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 创建订单\n     * @param userId 用户id\n     * @param productId 产品id\n     * @param count    产品数量\n     * @param money\n     */")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GlobalTransactional")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rollbackFor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//使用seata全局事务")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" productId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BigDecimal")]),s._v(" money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//1.扣减库存")]),s._v("\n        productFeignClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("deductProduct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("productId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//2.扣减余额")]),s._v("\n        accountDubboApi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("deductMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//3.创建订单")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderEntity")]),s._v(" orderEntity "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        orderEntity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        orderEntity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        orderEntity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setProductId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("productId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        orderEntity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUserId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"异常了"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        baseMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("insert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("orderEntity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("h3",{attrs:{id:"_3、发生问题的情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、发生问题的情况"}},[s._v("#")]),s._v(" 3、发生问题的情况：")]),s._v(" "),a("blockquote",[a("p",[s._v("库存服务调用成功并且数据库库存已经减少，此时undo_log有一条库存更新记录")]),s._v(" "),a("p",[s._v("当调用余额服务扣减余额时，发现余额不足抛出异常")]),s._v(" "),a("p",[s._v("库存服务进行回滚，并删除了undo_log中的内容")])]),s._v(" "),a("blockquote",[a("p",[s._v("库存服务成功，数据库更新成功，undo_log有一条库存更新记录")]),s._v(" "),a("p",[s._v("账户服务成功，数据库更新成功，undo_log有一条账户更新记录")]),s._v(" "),a("p",[s._v("订单服务本身出现异常，对库存服务和账户服务进行回滚，删除undo_log中的两条记录")])]),s._v(" "),a("h2",{attrs:{id:"三、探究seata原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、探究seata原理"}},[s._v("#")]),s._v(" 三、探究seata原理")]),s._v(" "),a("p",[s._v("http://seata.io/zh-cn/docs/user/quickstart.html")]),s._v(" "),a("p",[s._v("用户购买商品的业务逻辑。整个业务逻辑由3个微服务提供支持：")]),s._v(" "),a("ul",[a("li",[s._v("仓储服务：对给定的商品扣除仓储数量。")]),s._v(" "),a("li",[s._v("订单服务：根据采购需求创建订单。")]),s._v(" "),a("li",[s._v("帐户服务：从用户帐户中扣除余额。")])]),s._v(" "),a("h3",{attrs:{id:"架构图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构图"}},[s._v("#")]),s._v(" 架构图")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906233.png",alt:"Architecture"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906710.png",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"seata-at-模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seata-at-模式"}},[s._v("#")]),s._v(" Seata AT 模式")]),s._v(" "),a("h2",{attrs:{id:"整体机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#整体机制"}},[s._v("#")]),s._v(" 整体机制")]),s._v(" "),a("p",[s._v("两阶段提交协议的演变：")]),s._v(" "),a("ul",[a("li",[s._v("一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。")]),s._v(" "),a("li",[s._v("二阶段：\n"),a("ul",[a("li",[s._v("提交异步化，非常快速地完成。")]),s._v(" "),a("li",[s._v("回滚通过一阶段的回滚日志进行反向补偿。")])])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906857.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("既然 "),a("code",[s._v("Seata")]),s._v(" 是两段提交，那我们看看它在每个阶段都做了点啥？下边我们还以下单扣库存、扣余额举例。")]),s._v(" "),a("p",[s._v("先介绍 "),a("code",[s._v("Seata")]),s._v(" 分布式事务的几种角色：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("Transaction Coordinator(TC)")]),s._v(": 全局事务协调者，用来协调全局事务和各个分支事务（不同服务）的状态， 驱动全局事务和各个分支事务的回滚或提交。")]),s._v(" "),a("li",[a("code",[s._v("Transaction Manager™")]),s._v(": 事务管理者，业务层中用来开启/提交/回滚一个整体事务（在调用服务的方法中用注解开启事务）。")]),s._v(" "),a("li",[a("code",[s._v("Resource Manager(RM)")]),s._v(": 资源管理者，一般指业务数据库代表了一个分支事务（"),a("code",[s._v("Branch Transaction")]),s._v("），管理分支事务与 "),a("code",[s._v("TC")]),s._v(" 进行协调注册分支事务并且汇报分支事务的状态，驱动分支事务的提交或回滚。")])]),s._v(" "),a("blockquote",[a("p",[s._v("Seata 实现分布式事务，设计了一个关键角色 "),a("code",[s._v("UNDO_LOG")]),s._v(" （回滚日志记录表），我们在每个应用分布式事务的业务库中创建这张表，这个表的核心作用就是，将业务数据在更新前后的数据镜像组织成回滚日志，备份在 "),a("code",[s._v("UNDO_LOG")]),s._v(" 表中，以便业务异常能随时回滚。")])]),s._v(" "),a("h4",{attrs:{id:"第一个阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一个阶段"}},[s._v("#")]),s._v(" 第一个阶段")]),s._v(" "),a("p",[s._v("比如：下边我们更新 "),a("code",[s._v("user")]),s._v(" 表的 "),a("code",[s._v("name")]),s._v(" 字段。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'小富最帅'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'程序员内点事'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("首先 Seata 的 "),a("code",[s._v("JDBC")]),s._v(" 数据源代理通过对业务 SQL 解析，提取 SQL 的元数据，也就是得到 SQL 的类型（"),a("code",[s._v("UPDATE")]),s._v("），表（"),a("code",[s._v("user")]),s._v("），条件（"),a("code",[s._v("where name = '程序员内点事'")]),s._v("）等相关的信息。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906409.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("先查询数据前镜像，根据解析得到的条件信息，生成查询语句，定位一条数据。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'程序员内点事'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906522.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("紧接着执行业务 SQL，根据前镜像数据主键查询出后镜像数据")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906664.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("把业务数据在更新前后的数据镜像组织成回滚日志，将业务数据的更新和回滚日志在同一个本地事务中提交，分别插入到业务表和 "),a("code",[s._v("UNDO_LOG")]),s._v(" 表中。")]),s._v(" "),a("p",[s._v("回滚记录数据格式如下：包括 "),a("code",[s._v("afterImage")]),s._v(" 前镜像、"),a("code",[s._v("beforeImage")]),s._v(" 后镜像、 "),a("code",[s._v("branchId")]),s._v(" 分支事务ID、"),a("code",[s._v("xid")]),s._v(" 全局事务ID")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"branchId"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("641789253")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"xid"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xid:xxx"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"undoItems"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"afterImage"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"rows"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"fields"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"tableName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"product"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"beforeImage"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"rows"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"fields"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n                            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"tableName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"product"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"sqlType"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UPDATE"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("p",[s._v("这样就可以保证，任何提交的业务数据的更新一定有相应的回滚日志。")]),s._v(" "),a("blockquote",[a("p",[s._v("在本地事务提交前，各分支事务需向 "),a("code",[s._v("全局事务协调者")]),s._v(" TC 注册分支 ( "),a("code",[s._v("Branch Id")]),s._v(") ，为要修改的记录申请 "),a("strong",[s._v("全局锁")]),s._v(" ，要为这条数据加锁，利用 "),a("code",[s._v("SELECT FOR UPDATE")]),s._v(" 语句。而如果一直拿不到锁那就需要回滚本地事务。TM 开启事务后会生成全局唯一的 "),a("code",[s._v("XID")]),s._v("，会在各个调用的服务间进行传递。")])]),s._v(" "),a("p",[s._v("有了这样的机制，本地事务分支（"),a("code",[s._v("Branch Transaction")]),s._v("）便可以在全局事务的第一阶段提交，并马上释放本地事务锁定的资源。相比于传统的 "),a("code",[s._v("XA")]),s._v(" 事务在第二阶段释放资源，"),a("code",[s._v("Seata")]),s._v(" 降低了锁范围提高效率，即使第二阶段发生异常需要回滚，也可以快速 从"),a("code",[s._v("UNDO_LOG")]),s._v(" 表中找到对应回滚数据并反解析成 SQL 来达到回滚补偿。")]),s._v(" "),a("p",[s._v("最后本地事务提交，业务数据的更新和前面生成的 UNDO LOG 数据一并提交，并将本地事务提交的结果上报给全局事务协调者 TC。")]),s._v(" "),a("h4",{attrs:{id:"第二阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二阶段"}},[s._v("#")]),s._v(" 第二阶段")]),s._v(" "),a("p",[s._v("第二阶段是根据各分支的决议做提交或回滚：")]),s._v(" "),a("ul",[a("li",[s._v("如果决议是全局提交，此时各分支事务已提交并成功，这时 "),a("code",[s._v("全局事务协调者（TC）")]),s._v(" 会向分支发送第二阶段的请求。TM收到 TC 的分支提交请求，该请求会被放入一个异步任务队列中，并马上返回提交成功结果给 TC。异步队列中会异步和批量地根据 "),a("code",[s._v("Branch ID")]),s._v(" 查找并删除相应 "),a("code",[s._v("UNDO LOG")]),s._v(" 回滚记录。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906335.jpg",alt:"img"}})]),s._v(" "),a("ul",[a("li",[a("p",[s._v("如果决议是全局回滚，过程比全局提交麻烦一点，"),a("code",[s._v("RM")]),s._v(" 服务方收到 "),a("code",[s._v("TC")]),s._v(" 全局协调者发来的回滚请求，通过 "),a("code",[s._v("XID")]),s._v(" 和 "),a("code",[s._v("Branch ID")]),s._v(" 找到相应的回滚日志记录，通过回滚记录生成反向的更新 SQL 并执行，以完成分支的回滚。")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：这里删除回滚日志记录操作，一定是在本地业务事务执行之后")])])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906850.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("以一个示例来说明：")]),s._v(" "),a("blockquote",[a("p",[s._v("两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 的初始值 1000。")])]),s._v(" "),a("p",[s._v("tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 "),a("strong",[s._v("全局锁")]),s._v(" ，本地提交释放本地锁。")]),s._v(" "),a("p",[s._v("tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 "),a("strong",[s._v("全局锁")]),s._v(" ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 "),a("strong",[s._v("全局锁")]),s._v(" 。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161906030.png",alt:"Write-Isolation: Commit"}})]),s._v(" "),a("p",[s._v("tx1 二阶段全局提交，释放 "),a("strong",[s._v("全局锁")]),s._v(" 。tx2 拿到 "),a("strong",[s._v("全局锁")]),s._v(" 提交本地事务。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161907989.png",alt:"Write-Isolation: Rollback"}})]),s._v(" "),a("p",[s._v("如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。")]),s._v(" "),a("p",[s._v("此时，如果 tx2 仍在等待该数据的 "),a("strong",[s._v("全局锁")]),s._v("，同时持有本地锁，则 tx1 的分支回滚会失败。分支的回滚会一直重试，直到 tx2 的 "),a("strong",[s._v("全局锁")]),s._v(" 等锁超时，放弃 "),a("strong",[s._v("全局锁")]),s._v(" 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。")]),s._v(" "),a("p",[s._v("因为整个过程 "),a("strong",[s._v("全局锁")]),s._v(" 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 "),a("strong",[s._v("脏写")]),s._v(" 的问题。")]),s._v(" "),a("h4",{attrs:{id:"读隔离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读隔离"}},[s._v("#")]),s._v(" 读隔离")]),s._v(" "),a("p",[s._v("在数据库本地事务隔离级别 "),a("strong",[s._v("读已提交（Read Committed）")]),s._v(" 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 "),a("strong",[s._v("读未提交（Read Uncommitted）")]),s._v(" 。")]),s._v(" "),a("p",[s._v("如果应用在特定场景下，必需要求全局的 "),a("strong",[s._v("读已提交")]),s._v(" ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/ChetWei/img/raw/master/img/202109161907386.png",alt:"Read Isolation: SELECT FOR UPDATE"}})]),s._v(" "),a("p",[s._v("SELECT FOR UPDATE 语句的执行会申请 "),a("strong",[s._v("全局锁")]),s._v(" ，如果 "),a("strong",[s._v("全局锁")]),s._v(" 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 "),a("strong",[s._v("全局锁")]),s._v(" 拿到，即读取的相关数据是 "),a("strong",[s._v("已提交")]),s._v(" 的，才返回。")]),s._v(" "),a("blockquote",[a("p",[s._v("出于总体性能上的考虑，Seata 目前的方案并没有对所有 SELECT 语句都进行代理，仅针对 FOR UPDATE 的 SELECT 语句。")])])])}),[],!1,null,null,null);t.default=e.exports}}]);